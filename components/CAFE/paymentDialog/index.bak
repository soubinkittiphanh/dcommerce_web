<template>
  <div>
    <!-- Payment Dialog -->
    <v-dialog v-model="showDialog" max-width="1200" persistent>
      <v-card>
        <v-card-title class="primary white--text">
          <v-icon left color="white">mdi-credit-card</v-icon>
          Process Payment - Table {{ tableNumber }}
          <v-spacer></v-spacer>
          <v-btn
            icon
            color="white"
            @click="closeDialog"
            :disabled="actionLoading"
          >
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-card-title>

        <v-card-text class="pa-6">
          <!-- Payment Amount -->
          <v-card outlined class="mb-4">
            <v-card-text class="text-center pa-4">
              <div class="text-h4 font-weight-bold primary--text">
                {{ formatPrice(amount) }}
              </div>
              <div class="text-subtitle-1 grey--text">Total Amount to Pay</div>
            </v-card-text>
          </v-card>

          <!-- QR Code Button Section (only show if QR is enabled) -->
          <v-card v-if="enableQR" outlined class="mb-4">
            <v-card-text class="text-center pa-4">
              <v-btn
                color="deep-purple"
                large
                @click="showQRDialog = true"
                class="mb-2"
              >
                <v-icon left>mdi-qrcode</v-icon>
                Show QR Code
              </v-btn>
              <div class="caption grey--text">
                Generate QR code for mobile payment
              </div>
            </v-card-text>
          </v-card>

          <!-- Loading Payment Methods -->
          <div v-if="paymentLoading" class="text-center pa-4">
            <v-progress-circular
              size="48"
              color="primary"
              indeterminate
            ></v-progress-circular>
            <p class="mt-2">Loading payment methods...</p>
          </div>

          <!-- Payment Methods -->
          <div v-else>
            <v-subheader class="px-0">
              <v-icon left>mdi-wallet</v-icon>
              Select Payment Method
            </v-subheader>

            <v-row v-if="paymentMethods.length > 0">
              <v-col
                v-for="payment in paymentMethods"
                :key="payment.id"
                cols="6"
                class="pa-1"
              >
                <v-card
                  @click="selectedPaymentMethod = payment"
                  :color="
                    selectedPaymentMethod?.id === payment.id
                      ? getPaymentColor(payment.payment_code)
                      : ''
                  "
                  :class="[
                    'payment-method-card cursor-pointer text-center pa-3',
                    selectedPaymentMethod?.id === payment.id
                      ? 'white--text elevation-4'
                      : 'elevation-1',
                  ]"
                  hover
                  height="100"
                >
                  <v-icon
                    :color="
                      selectedPaymentMethod?.id === payment.id
                        ? 'white'
                        : getPaymentColor(payment.payment_code)
                    "
                    size="32"
                    class="mb-2"
                  >
                    {{ getPaymentIcon(payment.payment_code) }}
                  </v-icon>
                  <div
                    class="font-weight-medium"
                    :class="
                      selectedPaymentMethod?.id === payment.id
                        ? 'white--text'
                        : ''
                    "
                  >
                    {{ payment.payment_name }}
                  </div>
                  <div
                    class="caption"
                    :class="
                      selectedPaymentMethod?.id === payment.id
                        ? 'white--text'
                        : 'grey--text'
                    "
                  >
                    {{ payment.payment_code }}
                  </div>
                </v-card>
              </v-col>
            </v-row>

            <!-- No Payment Methods -->
            <v-alert v-else type="warning" outlined class="ma-0">
              <div class="d-flex align-center">
                <v-icon left>mdi-alert</v-icon>
                No active payment methods available
              </div>
              <v-btn
                small
                color="warning"
                class="mt-2"
                @click="$emit('reload-payment-methods')"
              >
                <v-icon left small>mdi-refresh</v-icon>
                Retry
              </v-btn>
            </v-alert>

            <!-- Selected Payment Details -->
            <v-card
              v-if="selectedPaymentMethod"
              outlined
              color="grey lighten-5"
              class="mt-4"
            >
              <v-card-text class="pa-3">
                <div class="d-flex align-center">
                  <v-icon
                    :color="getPaymentColor(selectedPaymentMethod.payment_code)"
                    class="mr-3"
                  >
                    {{ getPaymentIcon(selectedPaymentMethod.payment_code) }}
                  </v-icon>
                  <div>
                    <div class="font-weight-medium">
                      {{ selectedPaymentMethod.payment_name }}
                    </div>
                    <div class="caption grey--text">
                      {{
                        selectedPaymentMethod.payment_desc || 'No description'
                      }}
                    </div>
                  </div>
                </div>
              </v-card-text>
            </v-card>
          </div>
        </v-card-text>

        <v-card-actions class="pa-4">
          <v-btn
            color="grey"
            text
            @click="closeDialog"
            :disabled="actionLoading"
          >
            Cancel
          </v-btn>
          <v-spacer></v-spacer>
          <v-btn
            color="success"
            large
            @click="confirmPayment"
            :disabled="!selectedPaymentMethod || actionLoading"
            :loading="actionLoading"
          >
            <v-icon left>mdi-check</v-icon>
            Process Payment
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <!-- QR Code Dialog (only if QR is enabled) -->
    <v-dialog v-if="enableQR" v-model="showQRDialog" max-width="500" persistent>
      <v-card>
        <v-card-title class="deep-purple white--text">
          <v-icon left color="white">mdi-qrcode</v-icon>
          QR Payment Code
          <v-spacer></v-spacer>
          <v-btn
            icon
            color="white"
            @click="showQRDialog = false"
          >
            <v-icon>mdi-close</v-icon>
          </v-btn>
        </v-card-title>

        <v-card-text class="pa-6 text-center">
          <!-- Payment Amount -->
          <div class="mb-4">
            <div class="text-h4 font-weight-bold success--text">
              {{ formatPrice(amount) }}
            </div>
            <div class="text-subtitle-1 grey--text">
              Table {{ tableNumber }}
            </div>
          </div>

          <!-- QR Code -->
          <v-card outlined class="mb-4 pa-4">
            <img 
              :src="qrCodeUrl" 
              alt="QR Payment Code"
              style="width: 250px; height: 250px; display: block; margin: 0 auto;"
              @error="onQRError"
            />
          </v-card>

          <!-- Instructions -->
          <v-alert type="info" outlined dense class="mb-4">
            <div class="caption">
              <v-icon small left>mdi-information</v-icon>
              Scan this QR code with your mobile banking app to complete the payment
            </div>
          </v-alert>

          <!-- QR String (Optional - can be hidden) -->
          <v-expansion-panels v-if="showQRDetails" flat>
            <v-expansion-panel>
              <v-expansion-panel-header class="px-0">
                <span class="caption">QR Code Details</span>
              </v-expansion-panel-header>
              <v-expansion-panel-content>
                <v-textarea
                  :value="qrString"
                  readonly
                  outlined
                  dense
                  rows="3"
                  class="caption"
                  hide-details
                ></v-textarea>
                <v-btn
                  small
                  color="primary"
                  text
                  @click="copyQRString"
                  class="mt-2"
                >
                  <v-icon small left>{{ copied ? 'mdi-check' : 'mdi-content-copy' }}</v-icon>
                  {{ copied ? 'Copied!' : 'Copy QR String' }}
                </v-btn>
              </v-expansion-panel-content>
            </v-expansion-panel>
          </v-expansion-panels>
        </v-card-text>

        <v-card-actions class="pa-4">
          <v-btn
            color="primary"
            text
            @click="downloadQR"
          >
            <v-icon left>mdi-download</v-icon>
            Download
          </v-btn>
          <v-btn
            color="primary"
            text
            @click="shareQR"
          >
            <v-icon left>mdi-share</v-icon>
            Share
          </v-btn>
          <v-spacer></v-spacer>
          <v-btn
            color="success"
            @click="showQRDialog = false"
          >
            Done
          </v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>
  </div>
</template>

<script>
export default {
  name: 'UnifiedPaymentDialog',
  props: {
    // Dialog visibility
    show: {
      type: Boolean,
      default: false
    },
    
    // Payment details
    amount: {
      type: Number,
      default: 0
    },
    
    // Table information (flexible for both tableNumber and tableId)
    tableNumber: {
      type: [String, Number],
      default: ''
    },
    tableId: {
      type: [String, Number],
      default: ''
    },
    
    // Payment methods (flexible prop names)
    paymentMethods: {
      type: Array,
      default: () => []
    },
    paymentList: {
      type: Array,
      default: () => []
    },
    
    // Loading states
    paymentLoading: {
      type: Boolean,
      default: false
    },
    actionLoading: {
      type: Boolean,
      default: false
    },
    
    // QR Code features
    enableQR: {
      type: Boolean,
      default: true
    },
    showQRDetails: {
      type: Boolean,
      default: false
    },
    qrString: {
      type: String,
      default: "00020101021238640016A0052662846625770108701404180203002032 1IDB-000000000001417- M5204511453034185405100005802LA5907KHAMMAO6260011713a321asS321as2250302120713te rminal000010812test remarks63041c9f"
    }
  },
  
  data() {
    return {
      selectedPaymentMethod: null,
      showQRDialog: false,
      copied: false
    }
  },
  
  computed: {
    showDialog: {
      get() {
        return this.show
      },
      set(value) {
        if (!value) {
          this.closeDialog()
        }
      }
    },
    
    // Use the appropriate payment methods array
    activePaymentMethods() {
      return this.paymentMethods.length > 0 ? this.paymentMethods : this.paymentList
    },
    
    // Use the appropriate table identifier
    displayTableNumber() {
      return this.tableNumber || this.tableId || ''
    },
    
    qrCodeUrl() {
      const encodedString = encodeURIComponent(this.qrString.replace(/\s/g, ''));
      return `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodedString}&format=png&margin=20`;
    }
  },
  
  watch: {
    show(newVal) {
      if (!newVal) {
        this.resetComponent()
      }
    }
  },
  
  methods: {
    closeDialog() {
      this.resetComponent()
      this.$emit('close')
    },

    resetComponent() {
      this.selectedPaymentMethod = null
      this.showQRDialog = false
      this.copied = false
    },

    confirmPayment() {
      if (!this.selectedPaymentMethod) {
        this.$emit('show-message', 'Please select a payment method', 'warning', 'mdi-alert')
        return
      }

      this.$emit('confirm-payment', this.selectedPaymentMethod)
    },

    // QR Code methods
    async copyQRString() {
      try {
        if (navigator.clipboard) {
          await navigator.clipboard.writeText(this.qrString);
        } else {
          const textArea = document.createElement('textarea');
          textArea.value = this.qrString;
          document.body.appendChild(textArea);
          textArea.select();
          document.execCommand('copy');
          document.body.removeChild(textArea);
        }
        
        this.copied = true;
        setTimeout(() => {
          this.copied = false;
        }, 2000);
      } catch (err) {
        console.error('Failed to copy: ', err);
      }
    },
    
    downloadQR() {
      const link = document.createElement('a');
      link.href = this.qrCodeUrl;
      link.download = `qr-payment-table-${this.displayTableNumber}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    },
    
    shareQR() {
      if (navigator.share) {
        navigator.share({
          title: `Payment QR - Table ${this.displayTableNumber}`,
          text: `Payment QR Code for ${this.formatPrice(this.amount)}`,
          url: this.qrCodeUrl
        }).catch(err => console.log('Error sharing:', err));
      } else {
        this.copyQRString();
        this.$emit('show-message', 'QR code details copied to clipboard!', 'success', 'mdi-check');
      }
    },
    
    onQRError() {
      console.error('Failed to load QR code image');
      this.$emit('show-message', 'Failed to load QR code. Please try again.', 'error', 'mdi-alert');
    },

    // Utility methods
    formatPrice(amount, includeCurrency = true) {
      const formattedNumber = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(Math.round(amount || 0))

      return includeCurrency ? `${formattedNumber} ₭` : formattedNumber
    },

    getPaymentIcon(paymentCode) {
      const icons = {
        CASH: 'mdi-cash',
        CARD: 'mdi-credit-card',
        CREDIT: 'mdi-credit-card-outline',
        DEBIT: 'mdi-credit-card',
        MOBILE: 'mdi-cellphone',
        DIGITAL: 'mdi-wallet',
        BANK: 'mdi-bank',
        CHECK: 'mdi-checkbook',
      }
      return icons[paymentCode] || 'mdi-currency-usd'
    },

    getPaymentColor(paymentCode) {
      const colors = {
        CASH: 'green',
        CARD: 'blue',
        CREDIT: 'purple',
        DEBIT: 'indigo',
        MOBILE: 'orange',
        DIGITAL: 'teal',
        BANK: 'brown',
        CHECK: 'grey',
      }
      return colors[paymentCode] || 'primary'
    }
  }
}
</script>

<style scoped>
.cursor-pointer {
  cursor: pointer;
}

.payment-method-card {
  transition: all 0.3s ease;
  border: 2px solid transparent;
}

.payment-method-card:hover {
  transform: translateY(-2px);
}

.payment-method-card.elevation-4 {
  border: 2px solid rgba(255, 255, 255, 0.3);
}

.v-expansion-panel-content >>> .v-expansion-panel-content__wrap {
  padding-left: 0;
  padding-right: 0;
}
</style>